<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2048 game</title>
    <style>
        table {
            border-collapse:collapse;
            background-color:brown;
        }

        table td {
            border: 1px solid black;
            text-align: center;
            vertical-align:center;
            width:125px;
            height:125px;
        }

        #time {
            padding:1rem;
            margin:1rem;
            
        }
    </style>
    <script>

        /*
            [] Resolver problema com a inserção de novos elementos sem movimento de peças;
            [] Resolver problema de movimentos travados de peças para a direita e para a esquerda;
            [] Resolver problema de movimentos recursivos que faz com que as peças façam combos (combinações) em uma única jogada;
            [] Resolver problema ou bug referente à variável Game.occupied (não está sumindo peças);
        */

        function Squares (position, number, inserted) {
            this.position = position;
            this.number = number;
            this.inserted = inserted;
            /*
            this.insert = function (position, number) {
                this.position = position;
                this.number = number;
                let element = document.getElementById(this.position.toString());
                element.innerHTML = number.toString();
                if (this.inserted != true)
                    this.inserted = true;
            }

            this.update_position = function (position) {
                if(this.inserted) {
                    let element = document.getElementById(this.position.toString());
                    let other = document.getElementById(position.toString());
                    other.innerHTML = this.number.toString();
                    element.innerHTML = "";
                    this.position = position;
                }
            }

            this.remove_position = function() {
                if(this.inserted) {
                    let element = document.getElementById(this.position.toString());
                    element.innerHTML = "";
                    this.inserted = false;
                }
            }

            this.change_number = function(number) {
                let element = document.getElementById(this.position.toString());
                this.number = number;
                element.innerHTML = number.toString();
            }
            */
            this.insert = function (number) {
                this.number = number;
                let element = document.getElementById(this.position.toString());
                if (Game.DEBUG)
                    console.log("TEST this.position: ", this.position, "this.number", this.number)
                element.innerHTML = number.toString();
                if (this.inserted != true)
                    this.inserted = true;
            }

            this.remove_position = function() {
                if(this.inserted) {
                    let element = document.getElementById(this.position.toString());
                    element.innerHTML = "";
                    this.inserted = false;
                }
            }

            this.change_number = function(number) {
                let element = document.getElementById(this.position.toString());
                this.number = number;
                element.innerHTML = number.toString();
            }
        }

        var Game = { 
            DEBUG : true,
            ELEMENTS_NUMBER : 16,
            WIDTH: 4,
            HEIGHT : 4,
            square_array : Array(),
            occupied : 0,
            prepare : function () {
                document.body.onkeypress = function () {
                    if (event.keyCode == '119' || event.keyCode == '38' || event.keyCode == "87") {
                        let move_occured = false;
                        for (let i = 4; i < Game.ELEMENTS_NUMBER; i++) {
                            if (Game.DEBUG)
                                console.log ("i: ", i);
                            if (Game.square_array[i].inserted) {
                                let table_position = Game.square_array[i].position; // We take a position of a table cell
                                if (Game.DEBUG)
                                    console.log ("table_position: ", table_position);
                                // We want to check each element to determine whether or not to bring up
                                // If an element is 15, elements 11, 7 and 4 must be analyzed
                                table_position-=4; // We point the address of the cells at the top of the table
                                square_position = -1;
                                while(table_position >= 0) { // We move through the cells of the table in an upward direction
                                    //let real_position = Game.search_for_position(table_position);
                                    if (Game.DEBUG)
                                        console.log("TEST1 table_position: ", table_position, "square_position: ", square_position);
                                    if (!Game.square_array[table_position].inserted) { // If the cell contains no values, the cell will be a candidate for use
                                        square_position = table_position;
                                        move_occured = true;
                                    } else {
                                        if (Game.square_array[table_position].number == Game.square_array[i].number) {
                                            Game.square_array[table_position].change_number(Game.square_array[table_position].number *2);
                                            Game.remove_square(i);
                                            square_position = -1;
                                            move_occured = true;
                                        }
                                        break;
                                    }
                                    table_position-=4;
                                }

                                if(Game.DEBUG)
                                    console.log("TEST2 table_position: ", table_position, "square_position: ", square_position);
                                
                                if (square_position != -1) {
                                    Game.square_array[square_position].insert(Game.square_array[i].number);
                                    Game.square_array[i].remove_position();
                                }
                            }
                        }
                        if (move_occured)
                            Game.insert_square();
                        if (Game.DEBUG)
                            console.log("/////");

                    } else 
                    if (event.keyCode == '97' || event.keyCode == '65' || event.keyCode == '37') {
                        let move_occured = false;
                        for (let i = 0; i < Game.ELEMENTS_NUMBER; i++) {
                            if (Game.DEBUG)
                                console.log ("i: ", i);
                            if (Game.square_array[i].inserted) {
                                let table_position = Game.square_array[i].position; // We take a position of a table cell
                                if (Game.DEBUG)
                                    console.log ("table_position: ", table_position);
                                // We want to check each element to determine whether or not to bring up
                                // If an element is 5, elements 6 and 7 must be analyzed
                                table_position-=1; // We point the address of the cells at the right of the table
                                square_position = -1;
                                while(table_position >= Game.WIDTH * (Math.floor(i/Game.WIDTH))) { // We move through the cells of the table in a right direction
                                    //let real_position = Game.search_for_position(table_position);
                                    if (Game.DEBUG)
                                        console.log("TEST1 table_position: ", table_position, "square_position: ", square_position);
                                    if (!Game.square_array[table_position].inserted) { // If the cell contains no values, the cell will be a candidate for use
                                        square_position = table_position;
                                        move_occured = true;
                                    } else {
                                        if (Game.square_array[table_position].number == Game.square_array[i].number) {
                                            Game.square_array[table_position].change_number(Game.square_array[table_position].number *2);
                                            Game.remove_square(i);
                                            square_position = -1;
                                            move_occured = true;
                                        }
                                        break;
                                    }
                                    table_position-=1;
                                }

                                if(Game.DEBUG)
                                    console.log("TEST2 table_position: ", table_position, "square_position: ", square_position);
                                
                                if (square_position != -1) {
                                    Game.square_array[square_position].insert(Game.square_array[i].number);
                                    Game.square_array[i].remove_position();
                                }
                            }
                        }
                        if (move_occured)
                            Game.insert_square();
                        if (Game.DEBUG)
                            console.log("/////");
                    } else 
                    if (event.keyCode == '115' || event.keyCode == '40' || event.keyCode == '83') {
                        let move_occured = false;
                        for (let i = Game.ELEMENTS_NUMBER -5; i >= 0; i--) {
                            if (Game.DEBUG)
                                console.log ("i: ", i);
                            if (Game.square_array[i].inserted) {
                                let table_position = Game.square_array[i].position; // We take a position of a table cell
                                if (Game.DEBUG)
                                    console.log ("table_position: ", table_position);
                                // We want to check each element to determine whether or not to bring up
                                // If an element is 3, elements 7, 11 and 15 must be analyzed
                                table_position+=4; // We point the address of the cells at the bottom of the table
                                square_position = -1;
                                while(table_position <= Game.ELEMENTS_NUMBER -1) { // We move through the cells of the table in an forward direction
                                    if (Game.DEBUG)
                                        console.log("TEST1 table_position: ", table_position, "square_position: ", square_position);
                                    if (!Game.square_array[table_position].inserted) { // If the cell contains no values, the cell will be a candidate for use
                                        square_position = table_position;
                                        move_occured = true;
                                    } else {
                                        if (Game.square_array[table_position].number == Game.square_array[i].number) {
                                            Game.square_array[table_position].change_number(Game.square_array[table_position].number *2);
                                            Game.remove_square(i);
                                            square_position = -1;
                                            move_occured = true;
                                        }
                                        break;
                                    }
                                    table_position+=4;
                                }
                                if(Game.DEBUG)
                                    console.log("TEST2 table_position: ", table_position, "square_position: ", square_position);
                                
                                if (square_position != -1) {
                                    Game.square_array[square_position].insert(Game.square_array[i].number);
                                    Game.square_array[i].remove_position();
                                }
                            }
                        }
                        if (move_occured)
                            Game.insert_square();
                        if (Game.DEBUG)
                            console.log("/////");
                    } else 
                    if (event.keyCode == '100' || event.keyCode == '68' || event.keyCode == '39') {
                        let move_occured = false;
                        for (let i = Game.ELEMENTS_NUMBER -1; i >= 0; i--) {
                            if (Game.DEBUG)
                                console.log ("i: ", i);
                            if (Game.square_array[i].inserted) {
                                let table_position = Game.square_array[i].position; // We take a position of a table cell
                                if (Game.DEBUG)
                                    console.log ("table_position: ", table_position);
                                // We want to check each element to determine whether or not to bring up
                                // If an element is 5, elements 6 and 7 must be analyzed
                                table_position+=1; // We point the address of the cells at the right of the table
                                square_position = -1;
                                while(table_position < Game.WIDTH * (Math.floor(i/Game.WIDTH)+1)) { // We move through the cells of the table in a right direction
                                    //let real_position = Game.search_for_position(table_position);
                                    if (Game.DEBUG)
                                        console.log("TEST1 table_position: ", table_position, "square_position: ", square_position);
                                    if (!Game.square_array[table_position].inserted) { // If the cell contains no values, the cell will be a candidate for use
                                        square_position = table_position;
                                        move_occured = true;
                                    } else {
                                        if (Game.DEBUG)
                                            console.log("TEST Game.square_array[table_position].inserted ENTERED");
                                        if (Game.square_array[table_position].number == Game.square_array[i].number) {
                                            Game.square_array[table_position].change_number(Game.square_array[table_position].number *2);
                                            Game.remove_square(i);
                                            square_position = -1;
                                            move_occured = true;
                                        }
                                        break;
                                    }
                                    table_position+=1;
                                }

                                if(Game.DEBUG)
                                    console.log("TEST2 table_position: ", table_position, "square_position: ", square_position);
                                
                                if (square_position != -1) {
                                    Game.square_array[square_position].insert(Game.square_array[i].number);
                                    Game.square_array[i].remove_position();
                                }
                            }
                        }
                        if (move_occured)
                            Game.insert_square();
                        if (Game.DEBUG)
                            console.log("/////");
                    }
                }

                for (let i = 0; i < Game.ELEMENTS_NUMBER; i++) {
                    Game.square_array.push(new Squares(i,0,false));
                }

                Game.insert_square();
            }, 
            insert_square : function () {
                if (Game.DEBUG)
                    console.log("Game.occupied: ", Game.occupied)
                let count = 0;
                let inserted = false;
                if (Game.occupied < Game.ELEMENTS_NUMBER) {
                    let number = parseInt(Game.ELEMENTS_NUMBER*Math.random()); // We will randomly choose an empty square to fill it with a number
                    while(!inserted) {
                        // Now we want to insert into a square the number
                        if (!Game.square_array[number].inserted) {
                            Game.square_array[number].insert(2);
                            inserted = true;
                            if (Game.DEBUG)
                                console.log("TEST inserting new element: ", number);
                        } else
                        number = parseInt(Game.ELEMENTS_NUMBER*Math.random());
                        count++;
                        if (count > Game.ELEMENTS_NUMBER * 2) {
                            break;
                        }
                    }

                    if (!inserted) { // If the element has not been previously inserted within a period of time, we will insert it manually using a for
                        for(let i = 0; i < Game.ELEMENTS_NUMBER; i++) {
                            if (!Game.square_array[i].inserted) {
                                Game.square_array[i].insert(2);
                                inserted = true;
                            }
                        }
                        if (Game.DEBUG) {
                            console.log("TEST Is not inserted, tried again...");
                        }
                    }

                    if (inserted) {
                        Game.occupied+= 1;
                        if (Game.DEBUG)
                            console.log("TEST incrementing Game.occupied: ", Game.occupied);
                    }
                        
                }
            },

            remove_square : function (number) {
                if (Game.occupied > 0 && Game.square_array[number].inserted) {
                    Game.square_array[number].remove_position();
                    Game.occupied--;
                    if (Game.DEBUG)
                        console.log("TEST decrementing Game.occupied: ", Game.occupied, "removing square (number): ", number);
                }
            },

            /*search_for_position : function(position) {
                let index = -1;
                for (let i=0; i < Game.ELEMENTS_NUMBER; i++) {
                    if (Game.DEBUG) {
                        console.log("i: ", i, "position: ", position, "Game.square_array[i].position: ", Game.square_array[i].position, "Game.square_array[i].position == position: ", Game.square_array[i].position == position);
                    }
                    if (Game.square_array[i].position == position) {
                        index = i;
                        break;
                    }
                }
                return index;
            }*/
        }
    </script>
</head>
<body>
    <div id="time"></div>
    <table width="500px" height="500px">
        <tbody>
            <tr>
                <td id="0"></td>
                <td id="1"></td>
                <td id="2"></td>
                <td id="3"></td>
            </tr>
            <tr>
                <td id="4"></td>
                <td id="5"></td>
                <td id="6"></td>
                <td id="7"></td>
            </tr>
            <tr>
                <td id="8"></td>
                <td id="9"></td>
                <td id="10"></td>
                <td id="11"></td>
            </tr>
            <tr>
                <td id="12"></td>
                <td id="13"></td>
                <td id="14"></td>
                <td id="15"></td>
            </tr>
        </tbody>
    </table>
    <script>
        d1 = new Date();
        function updateDate() {
            d1 = new Date();
            time.innerHTML = d1.getHours() +":"+d1.getMinutes()+":"+d1.getSeconds();
        }
        
        setInterval(updateDate,1000);
        Game.prepare();
    </script>
</body>
</html>